<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EngineLab - Live Chess</title>
    <link rel="stylesheet" href="/static/chessground.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #161512;
            color: #bababa;
            height: 100vh;
            overflow: hidden;
            display: flex;
        }

        /* Hamburger menu button (mobile only) */
        #menu-toggle {
            display: none;
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 1001;
            background: #2a2825;
            border: 2px solid #3d3d3d;
            border-radius: 8px;
            width: 44px;
            height: 44px;
            cursor: pointer;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 5px;
            transition: all 0.3s ease;
        }

        #menu-toggle:hover {
            background: #33302c;
            border-color: #81b64c;
        }

        #menu-toggle span {
            width: 24px;
            height: 3px;
            background: #f0d9b5;
            border-radius: 2px;
            transition: all 0.3s ease;
        }

        #menu-toggle.active span:nth-child(1) {
            transform: rotate(45deg) translate(7px, 7px);
        }

        #menu-toggle.active span:nth-child(2) {
            opacity: 0;
        }

        #menu-toggle.active span:nth-child(3) {
            transform: rotate(-45deg) translate(6px, -6px);
        }

        /* Sidebar */
        #sidebar {
            width: 320px;
            background: #262421;
            border-right: 1px solid #3d3d3d;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            height: 100vh;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: 20px;
            background: #1a1a1a;
            border-bottom: 1px solid #3d3d3d;
            flex-shrink: 0;
        }

        .sidebar-header h1 {
            font-size: 1.6em;
            color: #f0d9b5;
            margin-bottom: 8px;
            font-weight: 700;
        }

        .sidebar-header .status {
            font-size: 0.9em;
            color: #999;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #dc3545;
        }

        .status.connected .status-dot {
            background: #28a745;
            box-shadow: 0 0 8px #28a745;
        }

        #game-list {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }

        .game-section {
            margin-bottom: 16px;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: #1a1a1a;
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            user-select: none;
        }

        .section-header:hover {
            background: #222;
        }

        .section-title {
            font-size: 0.85em;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #999;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-count {
            background: #81b64c;
            color: #1a1a1a;
            font-size: 0.75em;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 20px;
            text-align: center;
        }

        .section-toggle {
            font-size: 1.2em;
            transition: transform 0.2s;
        }

        .section-toggle.collapsed {
            transform: rotate(-90deg);
        }

        .section-games {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .section-games.collapsed {
            display: none;
        }

        .game-item {
            background: #2a2825;
            border: 2px solid transparent;
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .game-item:hover {
            background: #33302c;
            border-color: #4a4a4a;
        }

        .game-item.active {
            border-color: #81b64c;
            background: #2d3a1f;
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .game-title {
            font-weight: 600;
            font-size: 1em;
            color: #f0d9b5;
        }

        .game-status {
            font-size: 0.85em;
            padding: 3px 10px;
            border-radius: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .game-status.live {
            background: #28a745;
            color: white;
        }

        .game-status.finished {
            background: #6c757d;
            color: white;
        }

        .game-player {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            font-size: 0.9em;
        }

        .player-name {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .player-icon {
            font-size: 1.2em;
        }

        .player-clock {
            font-family: 'Courier New', monospace;
            font-weight: 700;
            color: #81b64c;
            font-size: 0.95em;
        }

        /* Main Content */
        #main-content {
            flex: 1;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 20px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        #no-games {
            text-align: center;
            color: #666;
        }

        #no-games h2 {
            font-size: 2em;
            color: #888;
            margin-bottom: 12px;
        }

        #no-games p {
            font-size: 1.1em;
        }

        #board-container {
            width: 100%;
            max-width: 550px;
            display: none;
            margin: 0 auto;
            padding: 10px 0;
        }

        #board-container.visible {
            display: block;
        }

        .player-bar {
            background: #2a2825;
            border-radius: 8px;
            padding: 8px 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            gap: 12px;
        }

        .player-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            min-width: 0;
        }

        .player-details {
            flex: 1;
            min-width: 0;
        }

        .player-name-large {
            font-size: 1em;
            font-weight: 700;
            color: #f0d9b5;
            margin-bottom: 2px;
        }

        .player-eval {
            font-size: 0.75em;
            color: #81b64c;
            font-weight: 600;
            font-family: 'Courier New', monospace;
            display: none;
        }

        .player-eval.negative {
            color: #dc3545;
        }

        .player-pv {
            font-size: 0.7em;
            font-family: 'Courier New', monospace;
            color: #999;
            display: none;
            margin-top: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .player-pv::before {
            content: "PV: ";
            color: #666;
        }

        .player-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .player-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4em;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            flex-shrink: 0;
        }

        .player-avatar.white {
            background: linear-gradient(135deg, #f0d9b5 0%, #d4c4a8 100%);
        }

        .player-clock-large {
            font-size: 1.3em;
            font-weight: 800;
            font-family: 'Courier New', monospace;
            color: #81b64c;
            background: #1a1a1a;
            padding: 6px 12px;
            border-radius: 8px;
            min-width: 75px;
            text-align: center;
            flex-shrink: 0;
        }

        .player-clock-large.low-time {
            color: #dc3545;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* Board */
        #board-wrapper {
            width: 100%;
            aspect-ratio: 1 / 1;
            position: relative;
        }

        #board {
            width: 100%;
            height: 100%;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
        }

        /* Arrow overlay */
        #board-arrows {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
        }

        .engine-arrow {
            stroke-width: 7;
            stroke-linecap: round;
            marker-end: url(#arrowhead);
            opacity: 0.8;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }

        .engine-arrow.primary {
            stroke: #81b64c;
            stroke-width: 8;
            opacity: 0.9;
        }

        .cg-wrap {
            width: 100%;
            height: 100%;
        }

        cg-board {
            background-color: #b58863;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3E%3Crect fill='%23b58863' width='8' height='8'/%3E%3Cpath fill='%23f0d9b5' d='M0 0h1v1H0zM2 0h1v1H2zM4 0h1v1H4zM6 0h1v1H6zM1 1h1v1H1zM3 1h1v1H3zM5 1h1v1H5zM7 1h1v1H7zM0 2h1v1H0zM2 2h1v1H2zM4 2h1v1H4zM6 2h1v1H6zM1 3h1v1H1zM3 3h1v1H3zM5 3h1v1H5zM7 3h1v1H7zM0 4h1v1H0zM2 4h1v1H2zM4 4h1v1H4zM6 4h1v1H6zM1 5h1v1H1zM3 5h1v1H3zM5 5h1v1H5zM7 5h1v1H7zM0 6h1v1H0zM2 6h1v1H2zM4 6h1v1H4zM6 6h1v1H6zM1 7h1v1H1zM3 7h1v1H3zM5 7h1v1H5zM7 7h1v1H7z'/%3E%3C/svg%3E");
            background-size: 100% 100%;
        }

        piece.white.king { background-image: url('/static/pieces/wK.svg'); }
        piece.white.queen { background-image: url('/static/pieces/wQ.svg'); }
        piece.white.rook { background-image: url('/static/pieces/wR.svg'); }
        piece.white.bishop { background-image: url('/static/pieces/wB.svg'); }
        piece.white.knight { background-image: url('/static/pieces/wN.svg'); }
        piece.white.pawn { background-image: url('/static/pieces/wP.svg'); }
        piece.black.king { background-image: url('/static/pieces/bK.svg'); }
        piece.black.queen { background-image: url('/static/pieces/bQ.svg'); }
        piece.black.rook { background-image: url('/static/pieces/bR.svg'); }
        piece.black.bishop { background-image: url('/static/pieces/bB.svg'); }
        piece.black.knight { background-image: url('/static/pieces/bN.svg'); }
        piece.black.pawn { background-image: url('/static/pieces/bP.svg'); }

        piece {
            background-size: 88%;
            background-repeat: no-repeat;
            background-position: center;
        }

        .cg-wrap square.last-move {
            background-color: rgba(155, 199, 0, 0.41);
        }

        .cg-wrap square.selected {
            background-color: rgba(20, 85, 30, 0.5);
        }

        coords {
            color: #8b8b8b;
            font-weight: 600;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        ::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Mobile overlay */
        #sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 999;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        #sidebar-overlay.active {
            opacity: 1;
        }

        /* Desktop: 1200px+ */
        @media (max-width: 1200px) {
            #sidebar {
                width: 280px;
            }
        }

        /* Tablet: 768px - 900px */
        @media (max-width: 900px) {
            #sidebar {
                width: 280px;
            }
            
            #board-container {
                max-width: 500px;
            }
        }

        /* Mobile: < 768px */
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }

            /* Show hamburger menu */
            #menu-toggle {
                display: flex;
            }

            /* Sidebar becomes overlay */
            #sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                width: 280px;
                z-index: 1000;
                transform: translateX(-100%);
            }

            #sidebar.active {
                transform: translateX(0);
            }

            #sidebar-overlay {
                display: block;
            }

            /* Main content takes full screen */
            #main-content {
                width: 100%;
                height: 100vh;
                padding: 70px 10px 10px 10px;
            }

            #board-container {
                max-width: 100%;
                padding: 0;
            }

            #board-wrapper {
                width: 100%;
                max-width: 500px;
                margin: 0 auto;
            }

            .player-bar {
                padding: 8px 10px;
                gap: 8px;
            }

            .player-avatar {
                width: 32px;
                height: 32px;
                font-size: 1.2em;
            }

            .player-name-large {
                font-size: 0.9em;
            }

            .player-eval {
                font-size: 0.7em;
            }

            .player-pv {
                font-size: 0.65em;
            }

            .player-clock-large {
                font-size: 1.1em;
                padding: 5px 10px;
                min-width: 65px;
            }

            .sidebar-header {
                padding: 15px;
            }

            .sidebar-header h1 {
                font-size: 1.4em;
            }

            .game-item {
                padding: 10px;
            }

            #no-games h2 {
                font-size: 1.5em;
            }

            #no-games p {
                font-size: 1em;
            }
        }

        /* Small mobile: < 400px */
        @media (max-width: 400px) {
            #menu-toggle {
                width: 40px;
                height: 40px;
                top: 12px;
                left: 12px;
            }

            #menu-toggle span {
                width: 20px;
                height: 2px;
            }

            #main-content {
                padding: 65px 8px 8px 8px;
            }

            #sidebar {
                width: 260px;
            }

            .player-bar {
                padding: 6px 8px;
            }

            .player-avatar {
                width: 28px;
                height: 28px;
                font-size: 1em;
            }

            .player-name-large {
                font-size: 0.85em;
            }

            .player-clock-large {
                font-size: 1em;
                padding: 4px 8px;
                min-width: 60px;
            }
        }
    </style>
</head>
<body>
    <!-- Mobile menu toggle -->
    <div id="menu-toggle">
        <span></span>
        <span></span>
        <span></span>
    </div>

    <!-- Sidebar overlay for mobile -->
    <div id="sidebar-overlay"></div>

    <div id="sidebar">
        <div class="sidebar-header">
            <h1>‚ö° EngineLab</h1>
            <div class="status" id="status">
                <span class="status-dot"></span>
                Connecting...
            </div>
        </div>
        <div id="game-list"></div>
    </div>

    <div id="main-content">
        <div id="no-games">
            <h2>üéÆ No Active Games</h2>
            <p>Waiting for matches to start...</p>
        </div>
        
        <div id="board-container">
            <div class="player-bar">
                <div class="player-info">
                    <div class="player-avatar">‚ôö</div>
                    <div class="player-details">
                        <div class="player-name-large" id="black-name">Black</div>
                        <div class="player-eval" id="black-eval">+0.00</div>
                        <div class="player-pv" id="black-pv"></div>
                    </div>
                </div>
                <div class="player-right">
                    <div class="player-clock-large" id="black-clock">--:--</div>
                </div>
            </div>
            
            <div id="board-wrapper">
                <div id="board"></div>
                <svg id="board-arrows">
                    <defs>
                        <marker id="arrowhead" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto" markerUnits="strokeWidth">
                            <path d="M 0 0 L 6 3 L 0 6 L 1.5 3 z" fill="#81b64c" opacity="0.9" />
                        </marker>
                    </defs>
                </svg>
            </div>
            
            <div class="player-bar">
                <div class="player-info">
                    <div class="player-avatar white">‚ôî</div>
                    <div class="player-details">
                        <div class="player-name-large" id="white-name">White</div>
                        <div class="player-eval" id="white-eval">+0.00</div>
                        <div class="player-pv" id="white-pv"></div>
                    </div>
                </div>
                <div class="player-right">
                    <div class="player-clock-large" id="white-clock">--:--</div>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/chessground.js"></script>
    <script>
        const games = new Map();
        let board = null;
        let currentGameId = null;
        let ws = null;
        let reconnectAttempts = 0;
        let clockInterval = null;
        let archivedCollapsed = false;

        // Mobile menu toggle
        const menuToggle = document.getElementById('menu-toggle');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');

        menuToggle.addEventListener('click', () => {
            menuToggle.classList.toggle('active');
            sidebar.classList.toggle('active');
            sidebarOverlay.classList.toggle('active');
        });

        sidebarOverlay.addEventListener('click', () => {
            menuToggle.classList.remove('active');
            sidebar.classList.remove('active');
            sidebarOverlay.classList.remove('active');
        });

        // Close menu when selecting a game on mobile
        function closeMobileMenu() {
            if (window.innerWidth <= 768) {
                menuToggle.classList.remove('active');
                sidebar.classList.remove('active');
                sidebarOverlay.classList.remove('active');
            }
        }

        // Initialize Chessground
        if (typeof Chessground !== 'undefined' && typeof Chessground.Chessground === 'function') {
            console.log('‚úÖ Chessground loaded successfully');
            const boardElement = document.getElementById('board');
            board = Chessground.Chessground(boardElement, {
                coordinates: true,
                viewOnly: true,
                animation: {
                    enabled: true,
                    duration: 200
                },
                highlight: {
                    lastMove: true,
                    check: true
                }
            });
        } else {
            console.error('‚ùå Failed to load Chessground library');
        }

        function connectWebSocket() {
            const wsUrl = `ws://${window.location.host}/ws`;
            console.log(`üîå Connecting to ${wsUrl}...`);
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                console.log('‚úÖ WebSocket connected');
                reconnectAttempts = 0;
                const statusEl = document.getElementById('status');
                statusEl.innerHTML = '<span class="status-dot"></span>Connected';
                statusEl.className = 'status connected';
            };

            ws.onclose = () => {
                console.log('‚ùå WebSocket disconnected');
                const statusEl = document.getElementById('status');
                statusEl.innerHTML = '<span class="status-dot"></span>Disconnected';
                statusEl.className = 'status';
                
                if (reconnectAttempts < 10) {
                    const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 30000);
                    reconnectAttempts++;
                    console.log(`üîÑ Reconnecting in ${delay}ms (attempt ${reconnectAttempts})...`);
                    setTimeout(connectWebSocket, delay);
                }
            };

            ws.onerror = (error) => {
                console.error('‚ùå WebSocket error:', error);
            };

            ws.onmessage = (event) => {
                try {
                    const message = JSON.parse(event.data);
                    console.log('üì® Message received:', message.type);
                    handleMessage(message);
                } catch (e) {
                    console.error('Failed to parse WebSocket message:', e);
                }
            };
        }

        function handleMessage(message) {
            switch (message.type) {
                case 'connected':
                    console.log('Server welcome:', message.message);
                    break;
                case 'game_start':
                    handleGameStart(message);
                    break;
                case 'move':
                    handleMove(message);
                    break;
                case 'engine_thinking':
                    handleEngineThinking(message);
                    break;
                case 'game_end':
                    handleGameEnd(message);
                    break;
            }
        }

        function handleGameStart(data) {
            const gameId = data.gameId;
            console.log(`üéÆ Game ${gameId} started`);
            
            let moves = [];
            if (data.moves) {
                moves = Array.isArray(data.moves) ? data.moves : Array.from(data.moves);
            }
            
            games.set(gameId, {
                white: data.white || 'Engine White',
                black: data.black || 'Engine Black',
                moves: moves,
                fen: data.fen || 'rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1',
                whiteTime: data.whiteTime || 0,
                blackTime: data.blackTime || 0,
                status: 'running',
                whiteScore: data.whiteScore,
                blackScore: data.blackScore,
                whiteDepth: data.whiteDepth,
                blackDepth: data.blackDepth,
                whitePv: data.whitePv,
                blackPv: data.blackPv,
                lastUpdateTime: Date.now()
            });

            updateGameList();
            
            if (!currentGameId) {
                showGame(gameId);
            }
        }

        function handleMove(data) {
            const game = games.get(data.gameId);
            if (!game) return;
            
            game.moves.push(data.move);
            game.fen = data.fen;
            game.whiteTime = data.whiteTime || game.whiteTime;
            game.blackTime = data.blackTime || game.blackTime;
            game.lastUpdateTime = Date.now();
            
            if (data.whiteScore !== undefined) game.whiteScore = data.whiteScore;
            if (data.blackScore !== undefined) game.blackScore = data.blackScore;
            if (data.whiteDepth !== undefined) game.whiteDepth = data.whiteDepth;
            if (data.blackDepth !== undefined) game.blackDepth = data.blackDepth;
            if (data.whitePv !== undefined) game.whitePv = data.whitePv;
            if (data.blackPv !== undefined) game.blackPv = data.blackPv;
            
            if (currentGameId === data.gameId) {
                updateBoard();
                
                if (game.whiteScore !== undefined) {
                    updateEngineEval('white', game.whiteScore, game.whiteDepth);
                    updatePv('white', game.whitePv);
                }
                if (game.blackScore !== undefined) {
                    updateEngineEval('black', game.blackScore, game.blackDepth);
                    updatePv('black', game.blackPv);
                }
                
                const isWhiteTurn = game.fen.split(' ')[1] === 'w';
                const pv = isWhiteTurn ? game.whitePv : game.blackPv;
                if (pv) {
                    drawPvArrows(pv, game.fen);
                }
            }
            
            updateGameClocks();
        }

        function handleEngineThinking(data) {
            if (currentGameId !== data.gameId) return;
            
            const game = games.get(data.gameId);
            if (!game) return;
            
            const color = data.isWhite ? 'white' : 'black';
            if (data.score !== undefined) {
                updateEngineEval(color, data.score, data.depth);
            }
            
            if (data.pv) {
                updatePv(color, data.pv);
                drawPvArrows(data.pv, game.fen);
            }
        }

        function handleGameEnd(data) {
            const game = games.get(data.gameId);
            if (!game) return;
            
            game.status = 'finished';
            game.result = data.result;
            game.reason = data.reason;
            
            if (currentGameId === data.gameId) {
                if (clockInterval) {
                    clearInterval(clockInterval);
                    clockInterval = null;
                }
            }
            
            updateGameList();
            
            if (currentGameId === data.gameId) {
                updateBoard();
                
                setTimeout(() => {
                    const activeGames = getActiveGameIds();
                    if (activeGames.length > 0) {
                        showGame(activeGames[0]);
                    }
                }, 2000);
            }
        }

        function getActiveGameIds() {
            const activeGames = [];
            for (const [gameId, game] of games) {
                if (game.status === 'running') {
                    activeGames.push(gameId);
                }
            }
            return activeGames.sort((a, b) => a - b);
        }

        function updateGameList() {
            const container = document.getElementById('game-list');
            container.innerHTML = '';

            if (games.size === 0) {
                document.getElementById('no-games').style.display = 'block';
                document.getElementById('board-container').classList.remove('visible');
                return;
            }

            document.getElementById('no-games').style.display = 'none';

            const activeGames = [];
            const archivedGames = [];
            
            for (const [gameId, game] of games) {
                if (game.status === 'running') {
                    activeGames.push([gameId, game]);
                } else {
                    archivedGames.push([gameId, game]);
                }
            }

            activeGames.sort((a, b) => a[0] - b[0]);
            archivedGames.sort((a, b) => b[0] - a[0]);

            if (activeGames.length > 0) {
                const activeSection = createGameSection('üî¥ Live Games', activeGames, false);
                container.appendChild(activeSection);
            }

            if (archivedGames.length > 0) {
                const archivedSection = createGameSection('üìÅ Archived Games', archivedGames, archivedCollapsed);
                container.appendChild(archivedSection);
            }
        }

        function createGameSection(title, gamesArray, collapsed) {
            const section = document.createElement('div');
            section.className = 'game-section';

            const header = document.createElement('div');
            header.className = 'section-header';
            header.onclick = () => {
                const gamesContainer = section.querySelector('.section-games');
                const toggle = section.querySelector('.section-toggle');
                gamesContainer.classList.toggle('collapsed');
                toggle.classList.toggle('collapsed');
                
                if (title.includes('Archived')) {
                    archivedCollapsed = gamesContainer.classList.contains('collapsed');
                }
            };

            header.innerHTML = `
                <div class="section-title">
                    ${title}
                    <span class="section-count">${gamesArray.length}</span>
                </div>
                <span class="section-toggle ${collapsed ? 'collapsed' : ''}">‚ñº</span>
            `;

            section.appendChild(header);

            const gamesContainer = document.createElement('div');
            gamesContainer.className = 'section-games' + (collapsed ? ' collapsed' : '');

            for (const [gameId, game] of gamesArray) {
                const item = document.createElement('div');
                item.className = 'game-item' + (currentGameId === gameId ? ' active' : '');
                item.setAttribute('data-game-id', gameId);
                item.onclick = () => {
                    showGame(gameId);
                    closeMobileMenu();
                };

                const statusClass = game.status === 'running' ? 'live' : 'finished';
                const statusText = game.status === 'running' ? 'Live' : (game.result || 'Finished');

                item.innerHTML = `
                    <div class="game-header">
                        <div class="game-title">Game #${gameId}</div>
                        <div class="game-status ${statusClass}">${statusText}</div>
                    </div>
                    <div class="game-player">
                        <div class="player-name">
                            <span class="player-icon">‚ôî</span>
                            <span>${game.white}</span>
                        </div>
                        <span class="player-clock">${formatTime(game.whiteTime)}</span>
                    </div>
                    <div class="game-player">
                        <div class="player-name">
                            <span class="player-icon">‚ôö</span>
                            <span>${game.black}</span>
                        </div>
                        <span class="player-clock">${formatTime(game.blackTime)}</span>
                    </div>
                `;

                gamesContainer.appendChild(item);
            }

            section.appendChild(gamesContainer);
            return section;
        }

        function updateGameClocks() {
            for (const [gameId, game] of games) {
                const gameItem = document.querySelector(`.game-item[data-game-id="${gameId}"]`);
                if (gameItem) {
                    const playerDivs = gameItem.querySelectorAll('.game-player');
                    if (playerDivs.length >= 2) {
                        const whiteClockEl = playerDivs[0].querySelector('.player-clock');
                        const blackClockEl = playerDivs[1].querySelector('.player-clock');
                        if (whiteClockEl) whiteClockEl.textContent = formatTime(game.whiteTime);
                        if (blackClockEl) blackClockEl.textContent = formatTime(game.blackTime);
                    }
                }
            }
        }

        function showGame(gameId) {
            currentGameId = gameId;
            updateGameList();
            updateBoard();
            document.getElementById('board-container').classList.add('visible');
        }

        function updateBoard() {
            if (!currentGameId || !board) return;

            const game = games.get(currentGameId);
            if (!game) return;

            const lastMove = game.moves.length > 0 ? game.moves[game.moves.length - 1] : null;
            
            board.set({
                fen: game.fen,
                lastMove: lastMove && lastMove.length >= 4 ? 
                    [lastMove.substring(0, 2), lastMove.substring(2, 4)] : undefined
            });

            document.getElementById('white-name').textContent = game.white;
            document.getElementById('black-name').textContent = game.black;

            updateClockDisplay();

            if (game.whiteScore !== undefined) {
                updateEngineEval('white', game.whiteScore, game.whiteDepth);
                updatePv('white', game.whitePv);
            }
            if (game.blackScore !== undefined) {
                updateEngineEval('black', game.blackScore, game.blackDepth);
                updatePv('black', game.blackPv);
            }
            
            const isWhiteTurn = game.fen.split(' ')[1] === 'w';
            const pv = isWhiteTurn ? game.whitePv : game.blackPv;
            if (pv) {
                drawPvArrows(pv, game.fen);
            }
            
            startClockTimer();
        }

        function formatTime(ms, showMs = false) {
            if (ms < 0) ms = 0;
            
            const totalSeconds = Math.floor(ms / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            
            if (showMs && ms < 10000) {
                const milliseconds = Math.floor((ms % 1000) / 10);
                return `${seconds}.${milliseconds.toString().padStart(2, '0')}`;
            }
            
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        function startClockTimer() {
            if (clockInterval) {
                clearInterval(clockInterval);
                clockInterval = null;
            }
            
            const game = games.get(currentGameId);
            if (!game || game.status !== 'running') return;
            
            clockInterval = setInterval(() => {
                if (!currentGameId) {
                    clearInterval(clockInterval);
                    clockInterval = null;
                    return;
                }
                
                const game = games.get(currentGameId);
                if (!game || game.status !== 'running') {
                    clearInterval(clockInterval);
                    clockInterval = null;
                    return;
                }
                
                const isWhiteTurn = game.fen.split(' ')[1] === 'w';
                
                const now = Date.now();
                if (!game.lastUpdateTime) {
                    game.lastUpdateTime = now;
                    return;
                }
                
                const elapsed = now - game.lastUpdateTime;
                game.lastUpdateTime = now;
                
                if (isWhiteTurn) {
                    game.whiteTime = Math.max(0, game.whiteTime - elapsed);
                } else {
                    game.blackTime = Math.max(0, game.blackTime - elapsed);
                }
                
                updateClockDisplay();
            }, 100);
        }

        function updateClockDisplay() {
            if (!currentGameId) return;
            
            const game = games.get(currentGameId);
            if (!game) return;
            
            const whiteClockEl = document.getElementById('white-clock');
            const blackClockEl = document.getElementById('black-clock');
            
            const showWhiteMs = game.whiteTime < 10000;
            const showBlackMs = game.blackTime < 10000;
            
            whiteClockEl.textContent = formatTime(game.whiteTime, showWhiteMs);
            blackClockEl.textContent = formatTime(game.blackTime, showBlackMs);
            
            whiteClockEl.className = 'player-clock-large' + (game.whiteTime < 10000 ? ' low-time' : '');
            blackClockEl.className = 'player-clock-large' + (game.blackTime < 10000 ? ' low-time' : '');
        }

        function updateEngineEval(color, score, depth) {
            const evalEl = document.getElementById(`${color}-eval`);
            if (!evalEl) return;
            
            let displayScore;
            
            if (Math.abs(score) >= 9000) {
                const mateIn = Math.ceil((10000 - Math.abs(score)) / 100);
                displayScore = score >= 0 ? `M${mateIn}` : `-M${mateIn}`;
            } else {
                const scoreValue = (score / 100).toFixed(2);
                displayScore = score >= 0 ? `+${scoreValue}` : scoreValue;
            }
            
            if (depth !== undefined && depth !== null) {
                displayScore += ` (d${depth})`;
            }
            
            evalEl.textContent = displayScore;
            evalEl.className = 'player-eval' + (score < 0 ? ' negative' : '');
            evalEl.style.display = 'block';
        }

        function updatePv(color, pv) {
            const pvEl = document.getElementById(`${color}-pv`);
            if (!pvEl) return;
            
            if (pv && pv.trim() !== '') {
                pvEl.textContent = pv;
                pvEl.style.display = 'block';
            } else {
                pvEl.style.display = 'none';
            }
        }

        function drawPvArrows(pv, fen) {
            const svgEl = document.getElementById('board-arrows');
            if (!svgEl || !pv) {
                if (svgEl) svgEl.style.display = 'none';
                return;
            }
            
            const arrows = svgEl.querySelectorAll('.engine-arrow');
            arrows.forEach(arrow => arrow.remove());
            
            const moves = pv.trim().split(/\s+/);
            
            if (moves.length === 0 || moves[0].length < 4) {
                svgEl.style.display = 'none';
                return;
            }
            
            const move = moves[0];
            const from = move.substring(0, 2);
            const to = move.substring(2, 4);
            
            const boardWrapper = document.getElementById('board-wrapper');
            if (!boardWrapper) return;
            
            const boardRect = boardWrapper.getBoundingClientRect();
            const squareSize = boardRect.width / 8;
            
            const squareToCoords = (square) => {
                const file = square.charCodeAt(0) - 97;
                const rank = 8 - parseInt(square[1]);
                return {
                    x: (file + 0.5) * squareSize,
                    y: (rank + 0.5) * squareSize
                };
            };
            
            const fromCoords = squareToCoords(from);
            const toCoords = squareToCoords(to);
            
            const dx = toCoords.x - fromCoords.x;
            const dy = toCoords.y - fromCoords.y;
            const length = Math.sqrt(dx * dx + dy * dy);
            
            const startOffset = squareSize * 0.20;
            const endOffset = squareSize * 0.20;
            
            const startX = fromCoords.x + (dx / length) * startOffset;
            const startY = fromCoords.y + (dy / length) * startOffset;
            const endX = toCoords.x - (dx / length) * endOffset;
            const endY = toCoords.y - (dy / length) * endOffset;
            
            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('x1', startX);
            line.setAttribute('y1', startY);
            line.setAttribute('x2', endX);
            line.setAttribute('y2', endY);
            line.classList.add('engine-arrow', 'primary');
            
            svgEl.appendChild(line);
            svgEl.style.display = 'block';
        }

        connectWebSocket();
    </script>
</body>
</html>